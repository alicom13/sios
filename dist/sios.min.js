/*!
 * Sios v1.3.1 - Optimized HTTP Client
 * Production-ready with performance optimizations
 * @copyright  2025 Sios JS Team
 * @author     Ali Musthofa
 * @link       https://github.com/alicom13/sios
 * @license    MIT
 */
var Sios=(()=>{var f=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var b=(o,e)=>{for(var t in e)f(o,t,{get:e[t],enumerable:!0})},O=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of w(e))!T.call(o,s)&&s!==t&&f(o,s,{get:()=>e[s],enumerable:!(r=E(e,s))||r.enumerable});return o};var C=o=>O(f({},"__esModule",{value:!0}),o);var q={};b(q,{Sios:()=>u,SiosError:()=>c,default:()=>I});var u=class o{constructor(e={}){this.defaults=Object.seal({baseURL:"",timeout:1e4,headers:Object.freeze({Accept:"application/json"}),validateStatus:o._validateStatus,responseType:"json",withCredentials:!1,maxRetries:0,retryDelay:1e3,maxRetryDelay:3e4,strictInterceptors:!1,retryOnJsonError:!1,retryCondition:o._retryCondition,cacheEnabled:!1,cacheTTL:6e4,cacheMaxSize:100,throttleEnabled:!1,throttleLimit:10,throttleInterval:1e3,batchEnabled:!1,batchInterval:100,maxBatchSize:10,...e}),this.interceptors={request:Object.freeze([]),response:Object.freeze([])},this.activeRequests=new Map,this.cache=new Map,this.requestQueue=new Map,this.requestCount=0,this._statePool=[],this._configPool=[],this._MAX_POOL_SIZE=100,this.metrics={totalRequests:0,successfulRequests:0,failedRequests:0,cacheHits:0,cacheMisses:0,averageResponseTime:0},this.requestTimestamps=[],this._throttleCleanupInterval=setInterval(()=>{let t=Date.now();this.requestTimestamps=this.requestTimestamps.filter(r=>t-r<this.defaults.throttleInterval)},5e3)}static _validateStatus(e){return e>=200&&e<300}static _retryCondition(e,t,r){let s=(e.code==="NETWORK"||e.code?.startsWith("HTTP_5"))&&t<r.maxRetries;return r.retryOnJsonError&&e.code==="JSON_PARSE_ERROR"?s:s&&![501,505].includes(parseInt(e.code.split("_")[1]||0))}static _generateId(){return`sios_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}_getRequestState(){if(this._statePool.length>0){let e=this._statePool.pop();return e.id=o._generateId(),e.controller=null,e.delayController=null,e.cancelledManually=!1,e.timeoutId=null,e.timestamp=Date.now(),e.config=null,e.currentAttempt=0,e.maxAttempts=0,e.isTimedOut=!1,e.state="pending",e._cleanup=e._cleanup||new WeakMap,e}return{id:o._generateId(),controller:null,delayController:null,cancelledManually:!1,timeoutId:null,timestamp:Date.now(),config:null,currentAttempt:0,maxAttempts:0,isTimedOut:!1,state:"pending",_cleanup:new WeakMap}}_returnRequestState(e){this._statePool.length<this._MAX_POOL_SIZE?(this._cleanupStateResources(e),this._statePool.push(e)):this._cleanupStateResources(e)}_cleanupStateResources(e){e.timeoutId&&(clearTimeout(e.timeoutId),e.timeoutId=null),e.controller&&(e.controller.abort(),e.controller=null),e.delayController&&(e.delayController.abort(),e.delayController=null),e._cleanup&&(e._cleanup=new WeakMap)}_getCacheKey(e,t,r){let s=`${e}:${t}`;if(r&&Object.keys(r).length>0){let i=Object.entries(r).sort(([a],[n])=>a.localeCompare(n)).map(([a,n])=>`${a}=${n}`).join("&");s+=`:${i}`}return s}_setCache(e,t){if(this.cache.size>=this.defaults.cacheMaxSize){let r=this.cache.keys().next().value;this.cache.delete(r)}this.cache.set(e,{response:Object.freeze({...t,cached:!0,timestamp:Date.now()}),expiry:Date.now()+this.defaults.cacheTTL})}_getCachedResponse(e){let t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),this.metrics.cacheMisses++,null):(this.metrics.cacheHits++,this.cache.delete(e),this.cache.set(e,t),t.response):(this.metrics.cacheMisses++,null)}clearCache(e=null){if(!e){this.cache.clear();return}for(let t of this.cache.keys())t.includes(e)&&this.cache.delete(t)}_checkThrottle(){if(!this.defaults.throttleEnabled)return Promise.resolve();let e=Date.now();if(this.requestTimestamps=this.requestTimestamps.filter(s=>e-s<this.defaults.throttleInterval),this.requestTimestamps.length<this.defaults.throttleLimit)return this.requestTimestamps.push(e),Promise.resolve();let t=this.requestTimestamps[0],r=this.defaults.throttleInterval-(e-t);return new Promise(s=>{setTimeout(()=>{this.requestTimestamps.shift(),this.requestTimestamps.push(Date.now()),s()},Math.max(0,r))})}async request(e,t,r=null,s={}){let i=performance.now();this.metrics.totalRequests++,await this._checkThrottle();let a=this._getRequestState();this.activeRequests.set(a.id,a);let n=(async()=>{try{if(this.defaults.cacheEnabled&&e.toUpperCase()==="GET"&&!s.forceRefresh){let m=this._getCacheKey(e,t,s.params),y=this._getCachedResponse(m);if(y)return a.state="cached",y}let h=this._mergeConfig(e,t,r,s);a.config=h,a.maxAttempts=h.maxRetries+1;let l=await this._applyRequestInterceptors(h),R=await this._executeWithRetry(l,a),d=await this._processResponse(R,l,a);if(!l.validateStatus(d.status))throw this._createError(`Request failed with status ${d.status}`,`HTTP_${d.status}`,l,d);if(this.defaults.cacheEnabled&&e.toUpperCase()==="GET"&&!s.noCache){let m=this._getCacheKey(e,t,s.params);this._setCache(m,d)}let _=await this._applyResponseInterceptors({...d,config:l,requestId:a.id},l);return this.metrics.successfulRequests++,a.state="success",_}catch(h){throw this.metrics.failedRequests++,a.cancelledManually?(a.state="cancelled",this._createError("Request cancelled manually","CANCELLED",a.config)):a.isTimedOut?this._createError(`Request timeout after ${a.config?.timeout||1e4}ms`,"TIMEOUT",a.config):await this._applyErrorInterceptors(h,a.config)}finally{let l=performance.now()-i;this.metrics.averageResponseTime=(this.metrics.averageResponseTime*(this.metrics.totalRequests-1)+l)/this.metrics.totalRequests,this.activeRequests.delete(a.id),this._returnRequestState(a)}})();return n.requestId=a.id,n}_mergeConfig(e,t,r,s){let i=Object.create(this.defaults);Object.assign(i,{method:e.toUpperCase(),url:t,data:r,params:s.params||{},headers:{...this.defaults.headers,...s.headers}});for(let a in s)["headers","params"].includes(a)||(i[a]=s[a]);return Object.seal(i)}async _applyRequestInterceptors(e){if(this.interceptors.request.length===0)return e;let t=e;for(let r of this.interceptors.request)try{let s=await Promise.resolve(r.onFulfilled?.(t)||r(t));s&&typeof s=="object"&&(t={...t,...s})}catch(s){if(e.strictInterceptors)throw this._createError(`Request interceptor failed: ${s.message}`,"INTERCEPTOR_ERROR",e)}return t}async _applyResponseInterceptors(e,t){if(this.interceptors.response.length===0)return e;let r=e;for(let s of this.interceptors.response)if(s.onFulfilled)try{let i=await Promise.resolve(s.onFulfilled(r));i&&typeof i=="object"&&(r={...r,...i})}catch(i){if(t.strictInterceptors)throw i}return r}async _applyErrorInterceptors(e,t){if(this.interceptors.response.length===0)return e;let r=e;for(let s of this.interceptors.response)if(s.onRejected)try{let i=await Promise.resolve(s.onRejected(r));i&&i instanceof Error&&(r=i)}catch{}return r}async _executeWithRetry(e,t){let r=null;for(t.currentAttempt=0;t.currentAttempt<t.maxAttempts;t.currentAttempt++){if(t.cancelledManually)throw this._createError("Request cancelled","CANCELLED",e);if(t.currentAttempt>0){let s=this._calculateRetryDelay(t.currentAttempt,e.retryDelay,e.maxRetryDelay);await this._delay(s,t),t.controller&&t.controller.abort(),t.controller=new AbortController}try{return await this._executeSingleRequest(e,t)}catch(s){if(r=s,s.code==="CANCELLED"||s.code==="TIMEOUT"||!(t.currentAttempt<t.maxAttempts-1&&e.retryCondition(s,t.currentAttempt,e)))throw s;continue}}throw r}_calculateRetryDelay(e,t,r){let s=t*Math.pow(2,e-1),i=s*.1*Math.random();return Math.min(s+i,r)}async _delay(e,t){return new Promise((r,s)=>{let i=setTimeout(r,e);t.timeoutId=i;let a=()=>{clearTimeout(i),t.cancelledManually&&s(this._createError("Request cancelled during delay","CANCELLED",t.config))};t.controller&&t.controller.signal.addEventListener("abort",a)})}async _executeSingleRequest(e,t){return new Promise((r,s)=>{t.controller||(t.controller=new AbortController),t.timeoutId=setTimeout(()=>{t.isTimedOut=!0,t.controller.abort(),s(this._createError(`Request timeout after ${e.timeout}ms`,"TIMEOUT",e))},e.timeout);let i=this._buildFetchOptions(e,t);fetch(e.url,i).then(a=>{clearTimeout(t.timeoutId),t.timeoutId=null,r(a)}).catch(a=>{clearTimeout(t.timeoutId),t.timeoutId=null,s(this._createError(a.name==="AbortError"?t.isTimedOut?"Request timeout":"Request aborted":a.message||"Request failed",a.name==="AbortError"?t.isTimedOut?"TIMEOUT":"ABORTED":"NETWORK",e,null,a))})})}_buildFetchOptions(e,t){let r={method:e.method,headers:this._optimizeHeaders(e.headers),signal:t.controller.signal,credentials:e.withCredentials?"include":"same-origin",redirect:"follow"};return e.data!=null&&!["GET","HEAD"].includes(e.method)&&(e.data instanceof FormData?r.body=e.data:typeof e.data=="object"?(r.body=JSON.stringify(e.data),r.headers["Content-Type"]||(r.headers["Content-Type"]="application/json")):r.body=e.data),r}_optimizeHeaders(e){let t={};for(let r in e){let s=e[r];s!=null&&s!==""&&(t[r]=s)}return t}async _processResponse(e,t,r){let s={};e.headers.forEach((a,n)=>{s[n]=a});let i={data:null,status:e.status,statusText:e.statusText,headers:s,config:t};switch(t.responseType){case"text":i.data=await e.text();break;case"blob":i.data=await e.blob();break;case"arraybuffer":i.data=await e.arrayBuffer();break;case"json":try{let a=await e.text();i.data=a?this._fastJsonParse(a):null}catch(a){if(t.retryOnJsonError)throw this._createError("Failed to parse JSON response","JSON_PARSE_ERROR",t,i,a);i.data=null}break;default:i.data=await e.text()}return i}_fastJsonParse(e){if(!e.trim())return null;if(e.length>1e5)try{return JSON.parse(e)}catch{try{return(0,eval)(`(${e})`)}catch{throw new SyntaxError("Invalid JSON")}}return JSON.parse(e)}_createError(e,t,r,s,i){return new c(e,t,r,s,i)}get(e,t={}){if(this.defaults.batchEnabled&&!t.forceRefresh){let r=this._getCacheKey("GET",e,t.params);if(this.requestQueue.has(r))return this.requestQueue.get(r);let s=this.request("GET",e,null,t);return this.requestQueue.set(r,s),s.finally(()=>{this.requestQueue.delete(r)}),s}return this.request("GET",e,null,t)}post(e,t=null,r={}){return this.request("POST",e,t,r)}put(e,t=null,r={}){return this.request("PUT",e,t,r)}patch(e,t=null,r={}){return this.request("PATCH",e,t,r)}delete(e,t={}){return this.request("DELETE",e,null,t)}head(e,t={}){return this.request("HEAD",e,null,t)}options(e,t={}){return this.request("OPTIONS",e,null,t)}async upload(e,t,r={}){let s=new FormData;if(s.append("file",t),r.data)for(let[a,n]of Object.entries(r.data))s.append(a,n);let i={...r,headers:{...r.headers}};return delete i.headers["Content-Type"],this.request("POST",e,s,i)}async multiupload(e,t,r={}){let s=new FormData;if(t instanceof FileList)Array.from(t).forEach((a,n)=>{s.append(`files[${n}]`,a)});else if(Array.isArray(t))t.forEach((a,n)=>{s.append(`files[${n}]`,a)});else throw new c("Files must be Array or FileList","VALIDATION_ERROR");if(r.data)for(let[a,n]of Object.entries(r.data))s.append(a,n);let i={...r,headers:{...r.headers}};return delete i.headers["Content-Type"],this.request("POST",e,s,i)}intercept(e,t,r){if(!["request","response"].includes(e))throw new c("Invalid interceptor type","VALIDATION_ERROR");let s=r?Object.freeze({onFulfilled:t,onRejected:r}):t;return this.interceptors={...this.interceptors,[e]:Object.freeze([...this.interceptors[e],s])},()=>{let i=this.interceptors[e].indexOf(s);if(i>-1){let a=[...this.interceptors[e]];a.splice(i,1),this.interceptors={...this.interceptors,[e]:Object.freeze(a)}}}}cancel(e){let t=this.activeRequests.get(e);return t?(t.cancelledManually=!0,t.state="cancelled",t.controller&&t.controller.abort(),!0):!1}cancelAll(){for(let[e]of this.activeRequests)this.cancel(e)}getMetrics(){return{...this.metrics,activeRequests:this.activeRequests.size,cacheSize:this.cache.size,queueSize:this.requestQueue.size,poolSize:this._statePool.length}}resetMetrics(){this.metrics={totalRequests:0,successfulRequests:0,failedRequests:0,cacheHits:0,cacheMisses:0,averageResponseTime:0}}create(e={}){return new o({...this.defaults,...e})}destroy(){this.cancelAll(),this.clearCache(),this.requestQueue.clear(),this._throttleCleanupInterval&&clearInterval(this._throttleCleanupInterval),this._statePool.forEach(e=>this._cleanupStateResources(e)),this._statePool=[],this._configPool=[]}},c=class o extends Error{constructor(e,t,r,s,i){super(e),this.name="SiosError",this.code=t,this.config=r,this.response=s,this.originalError=i,this.isSiosError=!0,this.timestamp=Date.now(),Error.captureStackTrace&&Error.captureStackTrace(this,o)}toJSON(){return{name:this.name,message:this.message,code:this.code,timestamp:this.timestamp,stack:this.stack}}},p=new u;typeof window<"u"&&(window.Sios=u,window.sios=p,window.SiosError=c);typeof global<"u"&&(global.Sios=u,global.sios=p,global.SiosError=c);typeof self<"u"&&(self.Sios=u,self.sios=p,self.SiosError=c);var I=p;return C(q);})();
